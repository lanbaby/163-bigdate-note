## 调度系统的类别

我们谈到的调度系统一般分为两类：一类是**资源调度系统**，一类是**作业调度系统**。

### **资源调度（管理）系统**

`Yarn`、`mesos`、`omega`、`borg`、`fuxi`、`gaia`、`normandy`

这里调度系统一般更偏向底层，直接跟操作系统打交道，会对操作系统的资源进行抽象，抽象的资源一般有：内存、CPU、磁盘和网络带宽等等，能够实现集群化，整合大量节点机器的资源，能够满足资源需求巨大的业务场景。

并且在资源抽象的基础上提供任务模型，可以为上层应用提供统一的资源管理和任务调度。

调度系统的引入为集群在利用率、资源统一管理和数据共享方面带来了巨大好处。

衡量一个资源调度系统的标准有三点：

1. 抽象和隔离

    越好的资源调度系统往往能抽象出更多的资源类型，而且在任务调度的隔离方面也有更好的表现。

2. 集群规模，集群节点越多，管理难度越大。

    在集群规模达到一定程度的情况下，系统的复杂度会程指数上升，所以好的管理系统应该能够实现更大规模的集群化。

3. 稳定性。

    能够从容应对宕机，在集群节点越多的情况下，出现宕机节点的概率就越高，好的资源管理系统能够控制好系统宕机的级联反应。


### **作业调度系统**

`ozzie`、`azkaban`、`chronos`、`zeus`、`lhotse`、`schedulerXterm`、`elastic-job`、`saturn`

作业调度系统是一个偏上层的应用，其作用概括起来就是实现大数据任务的启动执行和调度，**注意：**这里是启动执行，而不是运行。

衡量一个作业调度系统的标准一般有以下四点：

1. 能够支持哪些大数据组件。

    能够支持越多越流行的组件说明作业调度系统越好。

2. 能够支持哪些调度模型

    能够支持越多的调度模型越好，因为这样可以覆盖更多的用户场景

3. 用户体验

    用户体验表现为作业调度系统是否会对工程师的代码有侵入，日志查看是否支持，异常发现是否及时。

4. 稳定性

    是否有失败重试，宕机恢复等等。

## 任务调度系统在大数据技术栈中的位置

![任务调度系统位置][1]

最底层是节点机器，这里的机器不一定是物理机，也可以是云环境中的虚拟机，机器配置最好一致，如果做不到一致最好能做到资源配比一致、操作系统版本一致。

底层之上是分布式文件系统和资源调度系统，它们对集群的资源进行统一的抽象管理，提供基于资源抽象的任务模型，并且进行相应的任务调度管理。注意这里的任务概念更加偏向底层，不是具体的大数据任务，可以类比为操作系统的进程。这一层会对外提供文件操作接口、任务创建、查看、终止接口，以及资源配额的操作接口。

资源调度系统之上是各类大数据组件，常见的有hive、spark、impala等，这里的各个组件有自己的独立的数据模型---比如spark就是RDD（弹性分布式数据集）---和特定的使用场景。这些组件会对待提供一套数据交互方案---比如sql或特定API，然后根据接收到SQL或者代码解析成针对数据模型的逻辑执行计划，把对数据模型的访问翻译成对分布式文件的访问，把具体的逻辑执行计划翻译成资源调度系统的作业，提交到下层，最终得到结果。

各个大数据组件之上就是大数据作业调度系统。作业调度系统会访问和封装各个底层的部署细节提供统一的作业提交和部署方案，并且围绕这两个核心完善周边功能，提高使用效率。

最上层就是统一的大数据开发平台，用户可以直接访问。

作业调度系统和用户比较接近，需要提供友好的访问和使用

作业调度系统需要能够支持各类大数据组件。

作业调度系统对资源隔离有一定的要求

## 调度系统有什么用？

如果没有调度系统，数据工程师依然可以通过API直接和大数据组件进行交互，完成作业的提交。

![no_azkaban][2]

数据开发调度系统的目的是提高数据工程师的开发效率，更好的利用/共享数据。


## 作业调度系统-定时分片类系统

这类调度系统适用的场景是任何任务可以拆分成多个小任务，并且各个小任务可以并行执行，没有或者很少有相互之间的依赖关系。任务调度的时间比较固定，一般就是定期执行。

这种系统中往往有一个基于时间轴的总线，总线上有多个挂载点，可以使每天、每小时、每分钟等等，用户根据自己的需求将自己的任务拆分成多个小任务挂在到具体的挂载点即可。

这类系统目前有：

> `TBSchedule`、`SchedulerX`、`Elastic-job`、`Saturn`

这类系统关注的目标是：

> 不漏不重，负载均衡，弹性扩容，失效转移

> 精确定时触发，强实时性和高可靠性

这类系统业务影响有：

> 对所调度的任务往往有代码侵入性要求。

> 有些系统还需要常驻Daemon进程，用于协助通讯。

## 作业调度系统-DAG工作流类系统

场景定位：

> 所服务的往往是流程比较复杂的场景，同一个任务的子任务相互依赖，不同的任务之间有依赖，同周期不同周期的任务相互有依赖，还有肯能依赖统一个任务的多个周期，或者依赖自己的上一个周期等等。

> 可能涉及到成百上千个相互交叉依赖关联的作业。

> 这种调度系统有: Oozie, Azkaban, Chronos, Zeus, Lhotse

关注目标：

> 丰富灵活的触发机制：时间，依赖，混合精确定时触发，强实时性和高可靠性

> 灵活的作业变更管理，流程管控

> 优先级管理，业务隔离，错误跟踪，异常报警

> 系统和业务健康监控，性能优化和问题诊断。

### 基本要素

DAG指的是有向无环图，有方向但是不存在环路的图。

1. Activity（Job、 Node）是DAG中的节点，任务拆分的最小单元。分类有以下几种：

    - 执行类型（这里Activity表示的是某种大数据组件任务）

        - MR/HVIE/SPARK/SQOOP/FLUME/JAVA/PYTHON...

        - SCRIPT/COMMAND

    - 控制类型

        - 条件节点，引用节点

    - 判断类型，类似于断言，用于判断某个条件是否成立

        - 如判断目录是否存在、任务是否完成等

        - 某个表是否存在主键冲突、分区表函数波动是否异常等等。

        - 根据判断结果可以结合控制类型节点进入特定分支或者立即发出报警等

2. WorkFlow(DAG, Flow, Task)

    - 由Job组成的有向无环图

    - 依赖关系确定走向

    - 拒绝循环依赖

3. Schedule(trigger)

    Schedule定义调度模式，也就是WorkFlow在什么情况下会被调度执行，Schedule的载体是flow。
    
    一般来说调度模式有三种：
    
    一种是周期性调度，单位可以是月周日时分秒，是最常见也是最广泛的调度；
    
    第二种是cromtab类的调度，调度可以配置，比如定时上午九点下午五点各执行一次，这种方式也可以实现周期性调度，与周期性调度一样都是基于时间的调度模式；
    
    第三种是条件触发，比如依赖的某个flow和job已经完成、某个table已经生成等等。

    调度模式可以相互组合，既有周期性调度又有条件触发。

    Schedule可以根据业务模式进行划分：是否是补数据（所谓补数据是调度的时间是已经过去的时间而不是未来的时间），补数据一般出现在基于时间的调度模式下。补数据的场景下，除了要保证flow正常调度执行之外，还需要做好流控，控制好并发和优先级，均衡系统负载，因为补数据可能补了过去很长一段时间的业务逻辑。

    任务计划执行时间：schedule.exec.time，指的是Schedule逻辑上触发flow执行的时间，实际场景下任务计划执行时间和任务实际执行时间会有一定的误差，在非补数据的场景下应该尽量减少误差。

    调度任务实例：任务计划执行时间 + Flow，表示flow在每次任务调度下的执行，可类比于数据 + 代码 = 进程。

## 基本架构

![azkaban_arch][3]

- Manager

    项目管理、调度触发、任务生成，是整个系统的大脑，负责读取元数据，构建调度逻辑，生成具体的调度任务实例，然后根据既定的分发策略、负载均衡，将调度任务逻辑分发给执行模块，同时接收执行模块的反馈，更新实例状态。

- Execute Model

    负责具体Job的执行，调用具体的大数据组件提交任务，并将执行的情况保存到日志中，回传给存储系统。

- Storage

    日志、项目包资源上传下载，比如jar包、配置资源、实例执行完毕后的日志等等。

- Meta Model

    提供元数据的管理，负责元数据的持久化和读取，一般而言flow，Schedule都属于元数据。

- 其他

    报警、监控统计


[1]: https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6%EF%BC%9AAzkaban/img/azkaban_position.png
[2]: https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6%EF%BC%9AAzkaban/img/no_azkaban.png
[3]: https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6%EF%BC%9AAzkaban/img/azkaban_arch.png
